---
title: "Part 1"
author: "YOUR NAME"
output: 
  html_document:
    code_folding: hide
    df_print: paged
    theme: sandstone
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(tidyverse)
library(lubridate)

```

Template file. Code will be included in folded blocks in the output to facilitate grading. Please knit this file and commit both the rmd and the html output. If you add external files to your analysis, please commit them to the files folder in this repository. NOTE: please do not commit large (15MB+) files to GitHub. Instead please denote the origin of the files in your code. 

```{r}
#example connection to database. note that you have to download the database from onedrive

con <- DBI::dbConnect(RSQLite::SQLite(), "../database/detroit.sqlite")

# sales tbl

dplyr::tbl(con, 'sales')

# convert to tibble
#dplyr::tbl(con, 'sales') %>% dplyr::collect()

# sql query

dplyr::tbl(con, 'sales') %>% count(year(sale_date))

#dplyr::tbl(con, 'sales') %>% count(year(sale_date)) %>% show_query()

```

```{r}
dplyr::tbl(con, 'assessments')
```

```{r}
joined = 
  dplyr::tbl(con, 'sales') %>%
  inner_join(dplyr::tbl(con, 'assessments'), by = c('parcel_num'='PARCELNO'))

joined
```

```{r}
joined %>%
  filter(sale_price < 1000) %>%
  ggplot(aes(x = sale_price)) +
  geom_histogram()
```

```{r}
joined %>%
  filter(sale_price < 1000) %>%
  ggplot(aes(x = ASSESSEDVALUE)) +
  geom_histogram()
```

```{r}
joined %>%
  group_by(sale_terms) %>%
  count() %>% 
  arrange(desc(n))
```

```{r}
joined %>%
  filter(sale_terms %in% c('NO CONSIDERATION', 'EXEMPT/GOVT')) %>%
  ggplot(aes(x = ASSESSEDVALUE)) +
  geom_boxplot() + 
  xlim(0, 40000) 
```

As we can see from the histogram above, there are many properties sold at strange values, like at 0 or 1 dollar. This could have been a part of some revitalization program where property is sold cheaply to residents or reclaimed by the city, as evidenced by the grantor being some government entity like *CITY OF DETROIT* and sale terms like *EXEMPT/GOVT* but there isn't enough information confirm the strange values. The is true of assessed values as well. What does it mean for a property to have a zero assessed value? Considering that even "arm's length" transactions have this issue, there appears to be a potential data ingestion issue.

```{r}
joined %>%  
  collect() %>%
  filter(str_detect(sale_terms, regex("VALID ARMS LENGTH", ignore_case = TRUE))) %>%
  filter(sale_price < 1000) %>%
  ggplot(aes(x = ASSESSEDVALUE)) +
  geom_histogram()
```

But according to the definition of the various sales terms, only "arm's length" sales are supposedly representative of the market. So we will examine only those. For the sake of simplicity let's restrict the data to the valuations to the lower half first initial inspection.

```{r}
joined %>%
  collect() %>%
  filter(str_detect(sale_terms, regex("VALID ARMS LENGTH", ignore_case = TRUE))) %>%
  filter(ASSESSEDVALUE > 4000 & ASSESSEDVALUE < 20000) %>%
  pivot_longer(cols = c('sale_price','ASSESSEDVALUE'), names_to = "type", values_to = "value") %>%
  ggplot(aes(x=value, fill=type)) +
  geom_histogram(alpha=0.5, position = 'identity', binwidth = 1000) +
  xlim(0, 100000)
```

Here we note a sharp difference in the shapes of the distribution of the assessment values versus actual sale values. Also, strangely, there appears to be a sharp cutoff around $\$20,000$ in the assessed values samples.

As the University of Chicago analysts note, the typical way to examine fairness of assessments is through the ratios of the assessed values divided by the sales price.

```{r}
library(cmfproperty)
library(lubridate)

ratios =
  cmfproperty::reformat_data(
    joined %>%
      collect() %>%
      filter(str_detect(sale_terms, regex("VALID ARMS LENGTH", ignore_case = TRUE))) %>%
      mutate(sale_year = year(ymd(sale_date))),
    sale_col = "sale_price",
    assessment_col = "ASSESSEDVALUE",
    sale_year_col = "sale_year",
  )

ratios
```


```{r}
cmfproperty::make_report(ratios, 
                         jurisdiction_name = "Cook County, Illinois",
                         output_dir = "~/../Documents/GitHub/cmf-uchicago.github.io/") 
```

